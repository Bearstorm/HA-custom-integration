## ðŸ”µ ðŸ“¢ DIY â€‹Homeassistant zigbee Weather station  ðŸ“¢
***


[Open an issue on GitHub](https://github.com/Bearstorm/HA-custom-integration/Projects

/ESP32 â€‹â€‹â€‹Human presence/issues/new/choose).

## ðŸ“« Here are other links to my channels.

Bearstorm Homepage: https://www.bearstorm.com/

YouTube Channel URL: https://www.youtube.com/@Bearstormchannel

Instagram URL: https://www.instagram.com/bearstormchannel/

## ðŸ˜„ You can support my posts here

***
One-time donation link via PayPal:[here](https://www.paypal.com/donate/?hosted_button_id=PVATF8G5NZ392).
***

## What you need to buy can be found [here](https://www.bearstorm.com/Zigbee-Weather-station.html).

![obrÃ¡zok](https://github.com/user-attachments/assets/eda24e1d-bc37-4ed3-8261-04dc14a64f98)

This guide will walk you through building your own Zigbee weather station that integrates seamlessly with Home Assistant. The guide is divided into two parts: 
  
  1. Required Components and Assembly
  
  2. Programming  
  
  3. Integration with Home Assistant 
***

## 1. Required Components and Assembly
Hardware Components:

   â—‹
    CC2530 Zigbee Module â€“ Used for wireless communication via the Zigbee protocol.
    â—‹
    BME280 Sensor â€“ Measures temperature, humidity, and atmospheric pressure.
    â—‹
    Rain Sensor â€“ A tipping bucket rain gauge with a reed switch for measuring rainfall.
    â—‹
    Anemometer â€“ A device with a reed switch for measuring wind speed
    â—‹
    Wind Direction Sensor â€“ Uses a potentiometer or reed switches with resistors to detect wind direction.
    â—‹
    CC Debugger â€“ Used to flash the firmware onto the CC2530 module.
    â—‹
    Power Supply â€“ A stable 3.3V power source to power the system.

Wiring
1. CC2530 and BME280:

    â—‹
    Connect the BME280 sensor to the CC2530 via the I2C bus.
    â—‹
    Follow 

    to wire SCL and SDA pins properly.

2. â€‹Rain Sensor:

    â—‹
    Connect the reed switch of the rain sensor to P05 on the CC2530.
    â—‹
    Configure P05 as a digital input with a pull-up resistor.
    â—‹
    Connect the other end of the switch to GND.

3. Anemometer:

    â—‹
    Connect the reed switch of the anemometer to P07 on the CC2530.
    â—‹
    This pin will count pulses generated by the spinning anemometer.

4. Wind Direction Sensor:
                   *  This sensor typically works with either:

    â—‹
    A potentiometer, which provides an analog voltage output corresponding to the wind direction.
    â—‹
    A set of reed switches and resistors, which give a discrete voltage level based on wind vane position.

    â—‹
    If using a potentiometer, connect its output to an analog input (P06) on the CC2530.
    â—‹
    If using reed switches and resistors, connect them to P06 and configure this pin as an analog input.

5. Power Supply:

    â—‹
    Ensure that the entire system is powered by a stable 3.3V power source.

![ae111bac7a1d6278f29e0f733ddcde615889e753_2_666x500](https://github.com/user-attachments/assets/8b69332e-1d0a-455c-8d51-1c7984f39341)

***
##  2. Programming
  Flashing the CC2530 Firmware

1. Prepare the Firmware:

    â—‹
    Download the PTVO configurable firmware from 

    .
    â—‹
    This firmware allows you to configure the CC2530 module according to your needs.

2. â€‹â€‹Configure the Firmware:

    â—‹
    Enable I2C for BME280 and set the sensorâ€™s address (usually 0x76 or 0x77).
    â—‹
    Set P05 as a digital input for the rain sensor with a pull-up resistor.
    â—‹
    Set P03 as an analog input for the wind direction sensor.
    â—‹
    Set P07 as a pulse counter for the anemometer.
    â—‹
    And other settings as shown in the picture

![ptvo](https://github.com/user-attachments/assets/8e927516-4ab2-429b-8019-fbdde68ef45d)


   
3. â€‹Flash the Firmware to CC2530:
  Use the CC Debugger and to upload the firmware.  

![image1](https://github.com/user-attachments/assets/2c622b5f-394c-441e-a2bb-712f43240175)

 ***
 ## 3. Integration with Home Assistant
   Flashing the CC2530 Firmware

1. â€‹Install and Configure Zigbee2MQTT:

    â—‹
    Ensure is installed.

2. Pair the Device with Zigbee2MQTT:

    â—‹
    After flashing the firmware and powering the device, it should be detected by your Zigbee network.
    â—‹
    Check the Zigbee2MQTT logs for the new device.

3. Add Sensors to Home Assistant:

    â—‹
    The exact settings of sensors.yaml , configuration.yaml can be found here

    â—‹
    And now you can create conditions, triggers, automations, etc. in the zones you created. Good luck :D

***
## Home Assistant sensor.yaml


```yaml
#########################################################
#                                                       #
#      BME280 DATA                                      #
#                                                       #
######################################################### 

  - platform: template
    sensors:
      humidity_abs_shed:
        value_template: >-
          {% set h, t = states('sensor.humidity_shed') | float, states('sensor.temperature_shed') %}
          {% if not h or t == 'unknown' -%}
            'unknown'
          {%- else %}
            {% set t = t | float %}
            {{ (h*6.112*2.1674*e**((t*17.67)/(t+243.5))/(t+273.15))|round(1) }}
          {% endif %}
        unit_of_measurement: g/mÂ³
        friendly_name: Absolute Humidity shed

  - platform: template
    sensors:
      dewpoint_shed:
        friendly_name: "Dewpoint shed"
        value_template: >-
          {{ (log( states('sensor.humidity_shed')|int / 100 ) + 18.678 * states('sensor.temperature_shed')|float / (257.14 + states('sensor.temperature_shed')|float ) )| round (1) }}  
        unit_of_measurement: Â°C

#########################################################
#                                                       #
#      RAIN METER                                       #
#                                                       #
#########################################################  

  - platform: history_stats
    name: Daily rain clicks
    entity_id: # sem treba vloÅ¾iÅ¥ nÃ¡zov tvojej entity
    state: 'off'
    type: count
    start: '{{ now().replace(hour=0, minute=0, second=0) }}'
    end: '{{ now() }}'
    
  - platform: template
    sensors:
      rainfall_today:
        friendly_name: Rainfall today
        unit_of_measurement: mm
        value_template: >-
          {% set count = states('sensor.daily_rain_clicks') | int(0)  %}
          {% set mm_per_pulse = 0.30303 %}
          {% set mm = count * mm_per_pulse %}
          {{ mm|round(1, 'floor') }}    
          
#########################################################
#                                                       #
#      ANEMOMETER                                       #
#                                                       #
#########################################################

  - platform: template
    sensors:
      windspeed:
        friendly_name: Wind speed
        unit_of_measurement: m/s
        # m_per_pulse = (r * 2 * Pi)/2 = (0.09 * 2 * 3.14)/2 = 0.2862 m
        value_template: >-
          {% set count = states('sensor.wind_pulse') | int %}
          {% set m_per_pulse = 0.2826 %} 
          {% set mps = count * m_per_pulse %}
          {{ mps|round(0) }}    
          
  - platform: template
    sensors:
      windkmh:
        friendly_name: Wind speed
        unit_of_measurement: km/h
        value_template: >-
          {% set count = states('sensor.windspeed') | int %}
          {% set conversion =  0.2777778 %} 
          {% set mps = count * conversion %}
          {{ mps|round(0) }}      

  - platform: template
    sensors:
      windforce:
        friendly_name: Wind force
        icon_template: "mdi:weather-windy"
        value_template: "{% set wind = states('sensor.windspeed')|float %}
        {% set wind_round = wind|round(1) %}
        {% if wind <= 0.2 %}Bft: 0, Wind stil, {{wind_round}} m/s
        {% elif wind <= 1.5 %}Bft: 1, Zwak: flauwe wind, {{wind_round}} m/s
        {% elif wind <= 3.3 %}Bft: 2, Zwak, {{wind_round}} m/s
        {% elif wind <= 5.4 %}Bft: 3, Matig: lichte bries, {{wind_round}} m/s
        {% elif wind <= 7.9 %}Bft: 4, Matig: flauwe bries, {{wind_round}} m/s
        {% elif wind <= 10.7 %}Bft: 5, Vrij krachtig, {{wind_round}} m/s
        {% elif wind <= 13.8 %}Bft: 6, Krachtig, {{wind_round}} m/s
        {% elif wind <= 17.1 %}Bft: 7, Hard, {{wind_round}} m/s
        {% elif wind <= 20.7 %}Bft: 8, Stormachting, {{wind_round}} m/s
        {% elif wind <= 24.4 %}Bft: 9, Storm, {{wind_round}} m/s
        {% elif wind <= 28.4 %}Bft: 10, Zware storm, {{wind_round}} m/s
        {% elif wind <= 32.6 %}Bft: 11, Zeer zware storm, {{wind_round}} m/s
        {% else %}Bft: 12, Orkaan, {{wind_round}} m/s
        {%- endif %}"


  - platform: template
    sensors:
      beaufort: 
        friendly_name: Wind force
        icon_template: " mdi:weather-windy" 
        unit_of_measurement: Bft
        value_template: "{% set wind = states('sensor.windspeed')|float %} 
        {% if wind <= 0.2 %}0
        {% elif wind <= 1.5 %}1
        {% elif wind <= 3.3 %}2
        {% elif wind <= 5.4 %}3
        {% elif wind <= 7.9 %}4
        {% elif wind <= 10.7 %}5
        {% elif wind <= 13.8 %}6
        {% elif wind <= 17.1 %}7
        {% elif wind <= 20.7 %}8
        {% elif wind <= 24.4 %}9
        {% elif wind <= 28.4 %}10
        {% elif wind <= 32.6 %}11
        {% else %} > 32.6 %}12
        {%- endif %}"
             
#########################################################
#                                                       #
#      WIND DIRECTION                                   #
#                                                       #
#########################################################

  - platform: template
    sensors:
      wind_azimuth: 
        friendly_name: Wind azimuth
        unit_of_measurement: 'Â°'
        value_template: "{% set wind = states('sensor.wind_voltage')|float %}
        {% if wind <= 0.21 %}112.5
        {% elif wind <= 0.27 %}67.5
        {% elif wind <= 0.30 %}90.0
        {% elif wind <= 0.41 %}157.5
        {% elif wind <= 0.60 %}135.0
        {% elif wind <= 0.79 %}202.5
        {% elif wind <= 0.93 %}180.0
        {% elif wind <= 1.31 %}22.5
        {% elif wind <= 1.49 %}45.0
        {% elif wind <= 1.93 %}247.5
        {% elif wind <= 2.03 %}225.0
        {% elif wind <= 2.26 %}337.5
        {% elif wind <= 2.53 %}0.0
        {% elif wind <= 2.67 %}292.5
        {% elif wind <= 2.86 %}315.0
        {% elif wind <= 3.05 %}270
        {% else %} > 3.05 %}295.5
        {%- endif %}"

  - platform: template
    sensors:
      wind_direction:
        friendly_name: Wind direction
        icon_template: "mdi:compass-outline"
        value_template: >
          {% set degrees = states('sensor.wind_azimuth')|float %}
          {% set abbr = ['N','NNE','NE','ENE','E','ESE','SE',
          'SSE','S','SSW','SW','WSW','W','WNW','NW','NNW' ] %}
          {%- set i = ((degrees / 22.25) | round(0)) | int %}
          {%- set i = 0 if i == 16 else i %}
          {{ abbr[i] }}

#########################################################
#                                                       #
#            END OF CONFIGURATION FILE                  # 
#                                                       # 
#########################################################
```

***
## Home Assistant customize.yaml

```yaml
switch.meteostanica_l5:
  friendly_name: # your frielndly name

number.meteostanica_l6:
  friendly_name: # your frielndly name

switch.meteostanica_l7:
  friendly_name: # your frielndly name

sensor.meteostanica_voltage_l8:
  friendly_name: # your frielndly name
```

## Home Assistan template_sensors.yaml

```yaml
- sensor:
    - name: "Absolute Humidity shed"
      unit_of_measurement: "g/mÂ³"
      state: >-
        {% set h = states('sensor.humidity_shed') | float %}
        {% set t = states('sensor.temperature_shed') | float %}
        {% if h == 0 or t == 0 %}
          unknown
        {% else %}
          {{ (h * 6.112 * 2.1674 * (2.71828 ** ((t * 17.67) / (t + 243.5))) / (t + 273.15)) | round(1) }}
        {% endif %}

    - name: "Dewpoint shed"
      unit_of_measurement: "Â°C"
      state: >-
        {% set h = states('sensor.humidity_shed') | float %}
        {% set t = states('sensor.temperature_shed') | float %}
        {% if h == 0 or t == 0 %}
          unknown
        {% else %}
          {{ ((t - (14.55 + 0.114 * t) * (1 - (0.01 * h)) - ((2.5 + 0.007 * t) * (1 - (0.01 * h)) ** 3) - (15.9 + 0.117 * t) * (1 - (0.01 * h)) ** 14)) | round(1) }}
        {% endif %}

    - name: "Wind speed"
      unit_of_measurement: "m/s"
      state: >-
        {% set count = states('sensor.windpulse') | int %}
        {% set m_per_pulse = 0.2826 %}
        {{ (count * m_per_pulse) | round(0) }}

    - name: "Wind speed (km/h)"
      unit_of_measurement: "km/h"
      state: >-
        {% set mps = states('sensor.windspeed') | float %}
        {{ (mps * 3.6) | round(0) }}

    - name: "Wind force"
      unit_of_measurement: "Bft"
      state: >-
        {% set wind = states('sensor.windspeed') | float %}
        {% if wind <= 0.2 %} 0
        {% elif wind <= 1.5 %} 1
        {% elif wind <= 3.3 %} 2
        {% elif wind <= 5.4 %} 3
        {% elif wind <= 7.9 %} 4
        {% elif wind <= 10.7 %} 5
        {% elif wind <= 13.8 %} 6
        {% elif wind <= 17.1 %} 7
        {% elif wind <= 20.7 %} 8
        {% elif wind <= 24.4 %} 9
        {% elif wind <= 28.4 %} 10
        {% elif wind <= 32.6 %} 11
        {% else %} 12
        {% endif %}
```
## ðŸ˜„ You can support my posts here
One-time donation link: <a href="https://www.paypal.com/donate/?hosted_button_id=PVATF8G5NZ392">
  <img src="https://raw.githubusercontent.com/andreostrovsky/donate-with-paypal/925c5a9e397363c6f7a477973fdeed485df5fdd9/blue.svg" alt="Donate with PayPal" height="40"/>

## â„¢ **Apache License 2.0** â„¢ 
